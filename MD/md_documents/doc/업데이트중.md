# ì‹¤ì‹œê°„ ìƒìŠ¹ë¥  ìƒìœ„ 30ìœ„ ì¡°íšŒ ê¸°ëŠ¥ ì•ˆë‚´

í˜„ì¬ ì‹œìŠ¤í…œì€ í‚¤ì›€ì¦ê¶Œ APIì˜ **WebSocket** í†µì‹ ì„ ì´ìš©í•˜ì—¬ ì‹¤ì‹œê°„ìœ¼ë¡œ ìƒìŠ¹ë¥  ìƒìœ„ 30ìœ„ ì¢…ëª©ì„ ì¡°íšŒí•˜ê³  ìˆìŠµë‹ˆë‹¤. ì´ëŠ” ì£¼ê¸°ì ìœ¼ë¡œ ì„œë²„ì— ìš”ì²­ì„ ë³´ë‚´ëŠ” REST API ë°©ì‹ë³´ë‹¤ ì‹¤ì‹œê°„ ë°ì´í„° ìˆ˜ì‹ ì— ë” íš¨ìœ¨ì ì…ë‹ˆë‹¤.

## âœ… í˜„ì¬ êµ¬í˜„ ë°©ì‹ ìš”ì•½

1.  **Python WebSocket í´ë¼ì´ì–¸íŠ¸ (`get_top_30_rising_stocks.py`)**:
    *   í‚¤ì›€ì¦ê¶Œ ëª¨ì˜íˆ¬ì WebSocket ì„œë²„(`wss://...`)ì— ì ‘ì†í•©ë‹ˆë‹¤.
    *   ë°œê¸‰ë°›ì€ ì ‘ê·¼ í† í°ìœ¼ë¡œ ë¡œê·¸ì¸ì„ ìš”ì²­í•©ë‹ˆë‹¤.
    *   ë¡œê·¸ì¸ ì„±ê³µ í›„, `trnm: 'UPRATE30'` íŒŒë¼ë¯¸í„°ë¥¼ ì „ì†¡í•˜ì—¬ ìƒìŠ¹ë¥  ìƒìœ„ 30ìœ„ ì¢…ëª©ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ ìš”ì²­í•©ë‹ˆë‹¤.
    *   ì„œë²„ë¡œë¶€í„° ë°›ì€ ë°ì´í„°ë¥¼ JSON í˜•ì‹ìœ¼ë¡œ ì¶œë ¥í•˜ê³  ì—°ê²°ì„ ì¢…ë£Œí•©ë‹ˆë‹¤.

2.  **PHP ì›¹ í˜ì´ì§€ (`top_30_rising_stocks.php`)**:
    *   ìœ„ Python ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì„œë²„ì—ì„œ ì‹¤í–‰í•©ë‹ˆë‹¤.
    *   ìŠ¤í¬ë¦½íŠ¸ê°€ ì¶œë ¥í•œ JSON ë°ì´í„°ë¥¼ ë°›ì•„ íŒŒì‹±í•©ë‹ˆë‹¤.
    *   ê²°ê³¼ë¥¼ HTML í…Œì´ë¸” í˜•íƒœë¡œ ê°€ê³µí•˜ì—¬ ì‚¬ìš©ìì—ê²Œ ë³´ì—¬ì¤ë‹ˆë‹¤.

3.  **í†µí•© í˜ì´ì§€ (`api_info.php`)**:
    *   `api_info.php` í˜ì´ì§€ ë‚´ì— `top_30_rising_stocks.php` íŒŒì¼ì´ í¬í•¨ë˜ì–´ ìˆì–´, API ì •ë³´ì™€ í•¨ê»˜ ìƒìŠ¹ë¥  ìƒìœ„ ì¢…ëª©ì„ í•œëˆˆì— í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

## ğŸ“˜ REST API ë°©ì‹ê³¼ì˜ ë¹„êµ

ì‚¬ìš©ìê»˜ì„œ ì œê³µí•´ì£¼ì‹  `fn_ka10099` (REST API) ë°©ì‹ë„ ìƒìŠ¹ë¥  ìƒìœ„ ì¢…ëª©ì„ ì¡°íšŒí•˜ëŠ” ìœ íš¨í•œ ë°©ë²•ì…ë‹ˆë‹¤. í•˜ì§€ë§Œ ì´ ë°©ë²•ì€ **ìš”ì²­ ì‹œì ì˜ ìŠ¤ëƒ…ìƒ· ë°ì´í„°**ë¥¼ ì œê³µí•©ë‹ˆë‹¤.

ë°˜ë©´, í˜„ì¬ êµ¬í˜„ëœ **WebSocket ë°©ì‹**ì€ ì„œë²„ì—ì„œ ë°ì´í„° ë³€ê²½ì´ ë°œìƒí•  ë•Œë§ˆë‹¤ ë°ì´í„°ë¥¼ ë°€ì–´ì£¼ëŠ”(Push) ë°©ì‹ì— ë” ê°€ê¹Œì›Œ, **ì§„ì •í•œ ì˜ë¯¸ì˜ ì‹¤ì‹œê°„ ë°ì´í„°**ë¥¼ ì–»ëŠ” ë° ë” ì í•©í•©ë‹ˆë‹¤. ë”°ë¼ì„œ ë³¸ í”„ë¡œì íŠ¸ì—ì„œëŠ” ì‹¤ì‹œê°„ì„±ì´ ì¤‘ìš”í•œ ìƒìŠ¹ë¥  ìˆœìœ„ ì¡°íšŒë¥¼ ìœ„í•´ WebSocketì„ ì±„íƒí•˜ì˜€ìŠµë‹ˆë‹¤.

ì´ ê¸°ëŠ¥ì€ ì´ë¯¸ `api_info.php` í˜ì´ì§€ì— ì„±ê³µì ìœ¼ë¡œ í†µí•©ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

ìƒˆë¡­ê²Œ ì œì•ˆë“œë¦° ë°©ì‹(WebSocketì„ ì´ìš©í•œ ì‹¤ì‹œê°„ ë°ì´í„° ìˆ˜ì§‘)ìœ¼ë¡œ ê¸°ëŠ¥ì„ êµ¬í˜„í•œ ì „ì²´ ì†ŒìŠ¤ ì½”ë“œë¥¼ ì œê³µí•´ ë“œë¦½ë‹ˆë‹¤.

ì´ êµ¬í˜„ì€ get_all_stocks.pyê°€ ê¸°ë³¸ì ì¸ ì¢…ëª© ë¦¬ìŠ¤íŠ¸ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥í•˜ë©´, ìƒˆë¡œìš´ ìŠ¤í¬ë¦½íŠ¸ì¸ realtime_data_updater.pyê°€ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹¤ì‹œê°„ìœ¼ë¡œ ìƒì„¸ ì‹œì„¸ ì •ë³´ë¥¼ ë°›ì•„ì™€ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì—…ë°ì´íŠ¸í•˜ëŠ” ë°©ì‹ì…ë‹ˆë‹¤. ì›¹í˜ì´ì§€ëŠ” ì—…ë°ì´íŠ¸ëœ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì½ì–´ì™€ í‘œì‹œí•˜ê²Œ ë©ë‹ˆë‹¤.

1. kiwoom_api.py (ë³€ê²½ ì—†ìŒ - ì¬í™•ì¸ìš©)
ì´ì „ì— ì œê³µí•´ ë“œë¦° kiwoom_api.py íŒŒì¼ê³¼ ë™ì¼í•©ë‹ˆë‹¤. ì½˜ì†” ë¡œê¹…ì´ ì œê±°ë˜ì–´ PHPê°€ ì‹¤í–‰ ì‹œ ì¶œë ¥ìœ¼ë¡œ ì¸í•œ ë¬¸ì œë¥¼ ë°©ì§€í•©ë‹ˆë‹¤.

Python

import requests
import json
import configparser
import sqlite3
import os
import datetime
import logging

# --- íŒŒì¼ ê²½ë¡œ ì„¤ì • (ìƒëŒ€ ê²½ë¡œ ì‚¬ìš©) ---
CURRENT_DIR = os.path.dirname(os.path.abspath(__file__))
PROJECT_ROOT = os.path.join(CURRENT_DIR, '..')

CONFIG_FILE = os.path.join(PROJECT_ROOT, 'config.ini')
DB_FILE = os.path.join(PROJECT_ROOT, 'stock_data.db')
WORK_CONTENT_FILE = os.path.join(PROJECT_ROOT, 'md_documents', 'doc', '20250718_ì‘ì—…í• ë‚´ìš©.txt')

# --- ë¡œê·¸ íŒŒì¼ ì„¤ì • ---
LOG_DIR = os.path.join(PROJECT_ROOT, 'logs')
os.makedirs(LOG_DIR, exist_ok=True)

LOG_FILE = os.path.join(LOG_DIR, f"kiwoom_api_{datetime.datetime.now().strftime('%Y%m%d')}.log")

# ë¡œê±° ì„¤ì •
logger = logging.getLogger(__name__)
logger.setLevel(logging.INFO)

file_handler = logging.FileHandler(LOG_FILE, encoding='utf-8')
file_handler.setFormatter(logging.Formatter('%(asctime)s - %(name)s - %(levelname)s - %(message)s'))
logger.addHandler(file_handler)

def initialize_db():
    """ë°ì´í„°ë² ì´ìŠ¤ì™€ í…Œì´ë¸”ì„ ì´ˆê¸°í™”í•©ë‹ˆë‹¤."""
    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS api_info (
            id INTEGER PRIMARY KEY,
            access_token TEXT,
            account_number TEXT,
            account_name TEXT,
            balance REAL
        )
    ''')
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS work_in_progress (
            id INTEGER PRIMARY KEY,
            content TEXT,
            last_updated TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )
    ''')
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS korean_stock_list (
            stk_cd TEXT PRIMARY KEY,
            stk_nm TEXT,
            cur_prc REAL,
            cmpr_yd REAL,
            flu_rt TEXT,
            trde_qty INTEGER,
            trde_amt INTEGER,
            last_updated TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )
    ''')
    conn.commit()
    conn.close()
    logger.info("ë°ì´í„°ë² ì´ìŠ¤ì™€ í…Œì´ë¸”ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.")

def save_api_info(access_token, account_number, account_name, balance):
    """API ì •ë³´ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥í•©ë‹ˆë‹¤."""
    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()
    cursor.execute("DELETE FROM api_info")
    cursor.execute('''
        INSERT INTO api_info (access_token, account_number, account_name, balance)
        VALUES (?, ?, ?, ?)
    ''', (access_token, account_number, account_name, balance))
    conn.commit()
    conn.close()
    logger.info("API ì •ë³´ê°€ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.")

def get_api_info_from_db():
    """ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ API ì •ë³´ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤."""
    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()
    cursor.execute("SELECT access_token, account_number, account_name, balance FROM api_info LIMIT 1")
    info = cursor.fetchone()
    conn.close()
    return info

def save_work_content(content):
    """ì§„í–‰ ì¤‘ì¸ ì‘ì—… ë‚´ìš©ì„ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥í•©ë‹ˆë‹¤."""
    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()
    cursor.execute("DELETE FROM work_in_progress")
    cursor.execute('''
        INSERT INTO work_in_progress (content)
        VALUES (?)
    ''', (content,))
    conn.commit()
    conn.close()
    logger.info("ì§„í–‰ ì¤‘ì¸ ì‘ì—… ë‚´ìš©ì´ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.")

def get_work_content_from_db():
    """ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì§„í–‰ ì¤‘ì¸ ì‘ì—… ë‚´ìš©ì„ ê°€ì ¸ì˜µë‹ˆë‹¤."""
    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()
    cursor.execute("SELECT content FROM work_in_progress ORDER BY last_updated DESC LIMIT 1")
    info = cursor.fetchone()
    conn.close()
    return info[0] if info else ""

def save_all_stocks_to_db(stocks):
    """ì „ì²´ ì¢…ëª© ë¦¬ìŠ¤íŠ¸ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥/ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤."""
    if not stocks or (isinstance(stocks, dict) and "error" in stocks):
        logger.info("ì˜¤ë¥˜ê°€ ìˆê±°ë‚˜ ì €ì¥í•  ì¢…ëª© ë°ì´í„°ê°€ ì—†ì–´ DB ì €ì¥ì„ ê±´ë„ˆëœë‹ˆë‹¤.")
        return

    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()

    saved_count = 0
    for stock in stocks:
        if not isinstance(stock, dict) or 'code' not in stock:
            logger.warning(f"ìœ íš¨í•˜ì§€ ì•Šì€ ì¢…ëª© ë°ì´í„° í˜•ì‹ ë˜ëŠ” 'code' í•„ë“œ ëˆ„ë½: {stock}")
            continue

        stk_cd = stock.get('code')
        stk_nm = stock.get('name')
        cur_prc = float(stock.get('lastPrice', '0').replace(',', '')) if stock.get('lastPrice') else 0.0

        # WebSocket updaterê°€ ì´ í•„ë“œë“¤ì„ ì±„ìš¸ ê²ƒì´ë¯€ë¡œ ê¸°ë³¸ê°’ ìœ ì§€
        cmpr_yd = 0.0
        flu_rt = ''
        trde_qty = 0
        trde_amt = 0

        cursor.execute('''
            INSERT OR REPLACE INTO korean_stock_list
            (stk_cd, stk_nm, cur_prc, cmpr_yd, flu_rt, trde_qty, trde_amt, last_updated)
            VALUES (?, ?, ?, ?, ?, ?, ?, CURRENT_TIMESTAMP)
        ''', (
            stk_cd, stk_nm, cur_prc, cmpr_yd, flu_rt, trde_qty, trde_amt
        ))
        saved_count += 1

    conn.commit()
    conn.close()
    logger.info(f"ì´ {saved_count}ê°œì˜ ì¢…ëª© ì •ë³´ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥/ì—…ë°ì´íŠ¸í–ˆìŠµë‹ˆë‹¤.")

# ì ‘ê·¼í† í° ë°œê¸‰ í•¨ìˆ˜
def issue_access_token(base_url, data):
    """í‚¤ì›€ Open APIë¡œë¶€í„° ì ‘ê·¼ í† í°ì„ ë°œê¸‰ë°›ìŠµë‹ˆë‹¤."""
    host = base_url
    endpoint = '/oauth2/token'
    url = host + endpoint

    headers = {
        'Content-Type': 'application/json;charset=UTF-8',
        'api-id': 'kb00000',
    }
    try:
        response = requests.post(url, headers=headers, json=data)
        response.raise_for_status()
        res_json = response.json()
        logger.info('--- í† í° ë°œê¸‰ ì‘ë‹µ ---')
        logger.info(f"Code: {response.status_code}")
        logger.info(f"Body: {json.dumps(res_json, indent=4, ensure_ascii=False)}")

        if 'access_token' in res_json:
            return {'access_token': res_json['access_token']}
        elif 'token' in res_json:
            return {'access_token': res_json['token']}
        else:
            logger.error("ì‘ë‹µì— access_token ë˜ëŠ” token í•„ë“œê°€ ì—†ìŠµë‹ˆë‹¤.")
            return None
    except requests.exceptions.RequestException as e:
        logger.error(f"í† í° ë°œê¸‰ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
        return None
    except json.JSONDecodeError:
        logger.error(f"í† í° ë°œê¸‰ ì‘ë‹µ JSON íŒŒì‹± ì˜¤ë¥˜. ì‘ë‹µ: {response.text}")
        return None

# ê³„ì¢Œ ì •ë³´ ì¡°íšŒ ìš”ì²­ í•¨ìˆ˜ (kt00004)
def fn_kt00004_get_account_info(base_url, token, data, cont_yn='N', next_key=''):
    """í‚¤ì›€ Open APIë¥¼ í†µí•´ ê³„ì¢Œ ì •ë³´ë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤ (kt00004)."""
    host = base_url
    endpoint = '/api/dostk/acnt'
    url = host + endpoint

    headers = {
        'Content-Type': 'application/json;charset=UTF-8',
        'authorization': f'Bearer {token}',
        'cont-yn': cont_yn,
        'next-key': next_key,
        'api-id': 'kt00004',
    }
    try:
        response = requests.post(url, headers=headers, json=data)
        response.raise_for_status()
        res_json = response.json()
        logger.info('\n--- ê³„ì¢Œ ì •ë³´ ì¡°íšŒ ì‘ë‹µ (kt00004) ---')
        logger.info(f"Code: {response.status_code}")
        logger.info(f"Header: {json.dumps({key: response.headers.get(key) for key in ['next-key', 'cont-yn', 'api-id']}, indent=4, ensure_ascii=False)}")
        logger.info(f"Body: {json.dumps(res_json, indent=4, ensure_ascii=False)}")

        account_info_data = res_json.get('data', [])
        if isinstance(account_info_data, list) and account_info_data:
            first_account = account_info_data[0]
            account_number = first_account.get('entr', 'N/A')
            account_name = first_account.get('acnt_nm', 'N/A')
            balance = float(first_account.get('tot_est_amt', '0').replace(',', ''))
        else:
            account_number = res_json.get('entr', 'N/A')
            account_name = res_json.get('acnt_nm', 'N/A')
            balance = float(res_json.get('tot_est_amt', '0').replace(',', ''))

        return account_number, account_name, balance
    except requests.exceptions.RequestException as e:
        logger.error(f"ê³„ì¢Œ ì •ë³´ ì¡°íšŒ ìš”ì²­ (kt00004) ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
        return None, None, None
    except json.JSONDecodeError:
        logger.error(f"ê³„ì¢Œ ì •ë³´ ì¡°íšŒ ì‘ë‹µ (kt00004) JSON íŒŒì‹± ì˜¤ë¥˜. ì‘ë‹µ: {response.text}")
        return None, None, None


def get_kiwoom_token_and_account_info():
    """config.iniì—ì„œ API í‚¤ë¥¼ ì½ì–´ í† í°ì„ ë°œê¸‰ë°›ê³  ê³„ì¢Œ ì •ë³´ë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤."""
    config = configparser.ConfigParser()
    config.read(CONFIG_FILE)

    try:
        appkey = config.get('API', 'APP_KEY')
        appsecret_value = config.get('API', 'APP_SECRET')
        base_url = config.get('API', 'BASE_URL')
    except (configparser.NoSectionError, configparser.NoOptionError) as e:
        logger.error(f"ì˜¤ë¥˜: config.ini íŒŒì¼ì˜ ë‚´ìš©ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. ({e})")
        logger.error("Please ensure [API] section and APP_KEY, APP_SECRET, BASE_URL keys are present.")
        return None, None, None, None

    params_token = {'grant_type': 'client_credentials', 'appkey': appkey, 'secretkey': appsecret_value}
    token_response = issue_access_token(base_url=base_url, data=params_token)

    if token_response and token_response.get('access_token'):
        access_token = token_response['access_token']
        logger.info("\ní† í° ë°œê¸‰ ì„±ê³µ. ë°œê¸‰ëœ í† í°ìœ¼ë¡œ ê³„ì¢Œ ì¡°íšŒë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.")

        params_account = {
            'qry_tp': '0',
            'dmst_stex_tp': 'KRX',
        }
        account_number, account_name, balance = fn_kt00004_get_account_info(base_url=base_url, token=access_token, data=params_account)
        return access_token, account_number, account_name, balance
    else:
        logger.error("\ní† í° ë°œê¸‰ì— ì‹¤íŒ¨í•˜ì—¬ ê³„ì¢Œ ì¡°íšŒë¥¼ ì§„í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
        return None, None, None, None

if __name__ == "__main__":
    initialize_db()
    token, account_num, account_name, balance = get_kiwoom_token_and_account_info()
    if token:
        save_api_info(token, account_num, account_name, balance)
        logger.info("\nDBì—ì„œ ì •ë³´ í™•ì¸:")
        db_info = get_api_info_from_db()
        if db_info:
            logger.info(f"í† í° (DBì—ì„œ): {db_info[0][:5]}**********")
            logger.info(f"ê³„ì¢Œ ë²ˆí˜¸ (DBì—ì„œ): {db_info[1]}")
            logger.info(f"ê³„ì¢Œëª… (DBì—ì„œ): {db_info[2]}")
            logger.info(f"ì”ì•¡ (DBì—ì„œ): {db_info[3]}")
        else:
            logger.info("DBì—ì„œ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")

    if os.path.exists(WORK_CONTENT_FILE):
        with open(WORK_CONTENT_FILE, 'r', encoding='utf-8') as f:
            work_content = f.read()
        save_work_content(work_content)
    else:
        logger.warning(f"ê²½ê³ : ì‘ì—… ë‚´ìš© íŒŒì¼ì´ ë‹¤ìŒ ìœ„ì¹˜ì— ì—†ìŠµë‹ˆë‹¤: {WORK_CONTENT_FILE}")
2. get_all_stocks.py (ë³€ê²½ ì—†ìŒ - ì¬í™•ì¸ìš©)
ì´ ìŠ¤í¬ë¦½íŠ¸ëŠ” ì´ˆê¸° ì¢…ëª© ë¦¬ìŠ¤íŠ¸(ì¢…ëª©ì½”ë“œ, ì¢…ëª©ëª…, í˜„ì¬ê°€)ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥í•˜ëŠ” ì—­í• ì„ í•©ë‹ˆë‹¤. 'ì „ì¼ëŒ€ë¹„', 'ë“±ë½ë¥ ', 'ê±°ë˜ëŸ‰', 'ê±°ë˜ëŒ€ê¸ˆ' í•„ë“œëŠ” ê¸°ë³¸ê°’ìœ¼ë¡œ ì €ì¥ë˜ë©°, ìƒˆë¡­ê²Œ ì¶”ê°€ë  realtime_data_updater.pyê°€ ì´ í•„ë“œë“¤ì„ ì±„ìš¸ ê²ƒì…ë‹ˆë‹¤.

Python

import requests
import json
import configparser
import os
import time
import kiwoom_api # kiwoom_api ëª¨ë“ˆ import
import logging

logger = logging.getLogger('kiwoom_api')

# --- íŒŒì¼ ê²½ë¡œ ì„¤ì • (ìƒëŒ€ ê²½ë¡œ ì‚¬ìš©) ---
CURRENT_DIR = os.path.dirname(os.path.abspath(__file__))
PROJECT_ROOT = os.path.join(CURRENT_DIR, '..')

config = configparser.ConfigParser()
config_path = os.path.join(PROJECT_ROOT, 'config.ini')
config.read(config_path)

try:
    APP_KEY = config['API']['APP_KEY']
    APP_SECRET = config['API']['APP_SECRET']
    BASE_URL = config['API']['BASE_URL']
except (configparser.NoSectionError, configparser.NoOptionError) as e:
    logger.error(f"ì˜¤ë¥˜: config.ini íŒŒì¼ì— [API] ì„¹ì…˜ ë˜ëŠ” í•„ìš”í•œ í‚¤ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤. ({e})")
    logger.error("[API] ì„¹ì…˜ ì•ˆì— APP_KEY, APP_SECRET, BASE_URL í‚¤ê°€ ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.")
    APP_KEY = None
    APP_SECRET = None
    BASE_URL = None

# ì¢…ëª©ì •ë³´ ì¡°íšŒ (ka10099) - ì‹œì¥êµ¬ë¶„ ë° í˜ì´ì§€ë„¤ì´ì…˜ í¬í•¨
def get_all_stocks_list_by_market(token, base_url, market_type):
    """
    í‚¤ì›€ Open API (ka10099)ë¥¼ í†µí•´ íŠ¹ì • ì‹œì¥ì˜ ì¢…ëª© ì •ë³´ë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤.
    market_type: '0' (ì½”ìŠ¤í”¼), '10' (ì½”ìŠ¤ë‹¥)
    """
    host = base_url
    endpoint = '/api/dostk/stkinfo'
    url = host + endpoint

    market_stocks = []
    cont_yn = 'N'
    next_key = ''

    market_name = "ì½”ìŠ¤í”¼" if market_type == '0' else "ì½”ìŠ¤ë‹¥"
    logger.info(f"--- {market_name} ì¢…ëª© ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘...")

    while True:
        headers = {
            'Content-Type': 'application/json;charset=UTF-8',
            'authorization': f'Bearer {token}',
            'cont-yn': cont_yn,
            'next-key': next_key,
            'api-id': 'ka10099',
        }
        params = {
            'mrkt_tp': market_type,
        }

        try:
            response = requests.post(url, headers=headers, json=params)
            response.raise_for_status()

            res_json = response.json()

            logger.debug(f"Raw API ì‘ë‹µ for {market_name} (Page cont-yn={cont_yn}, next-key={next_key}): {json.dumps(res_json, indent=4, ensure_ascii=False)}")

            if res_json.get('list') and isinstance(res_json['list'], list):
                new_stocks = res_json['list']

                if new_stocks:
                    current_batch_count = len(new_stocks)
                    market_stocks.extend(new_stocks)
                    logger.info(f"({market_name}) í˜„ì¬ í˜ì´ì§€ì—ì„œ {current_batch_count}ê°œ ì¢…ëª© ì¶”ê°€ ì™„ë£Œ. í˜„ì¬ê¹Œì§€ ì´ {len(market_stocks)}ê°œ ìˆ˜ì§‘.")
                else:
                    logger.info(f"({market_name}) 'list' í•„ë“œëŠ” ì¡´ì¬í•˜ì§€ë§Œ ë” ì´ìƒ ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤. ë£¨í”„ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤.")
                    break
            else:
                logger.warning(f"API ì‘ë‹µì— 'list' í•„ë“œê°€ ì—†ê±°ë‚˜ ìœ íš¨í•œ ë¦¬ìŠ¤íŠ¸ê°€ ì•„ë‹™ë‹ˆë‹¤. ì‘ë‹µ: {json.dumps(res_json, indent=4, ensure_ascii=False)}")
                break

            cont_yn = response.headers.get('cont-yn', 'N')
            next_key = response.headers.get('next-key', '')

            if cont_yn != 'Y' or not next_key:
                logger.info(f"({market_name}) ë” ì´ìƒ ë‹¤ìŒ í˜ì´ì§€ê°€ ì—†ìŠµë‹ˆë‹¤. ìµœì¢… ìˆ˜ì§‘ ì™„ë£Œ.")
                break

            time.sleep(60)

        except requests.exceptions.RequestException as e:
            logger.error(f"API ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
            if e.response is not None:
                logger.error(f"ì‘ë‹µ ë‚´ìš©: {e.response.text}")
            return []
        except json.JSONDecodeError:
            logger.error(f"ì‘ë‹µ JSON íŒŒì‹± ì˜¤ë¥˜. ì‘ë‹µ: {response.text}")
            return []

    logger.info(f"--- ì´ {len(market_stocks)}ê°œì˜ {market_name} ì¢…ëª© ì •ë³´ ìˆ˜ì§‘ ì™„ë£Œ.")
    return market_stocks


if __name__ == '__main__':
    logger.info("--- ì½”ìŠ¤í”¼/ì½”ìŠ¤ë‹¥ ì „ì¢…ëª© ì •ë³´ ì—…ë°ì´íŠ¸ ì‹œì‘ ---")
    kiwoom_api.initialize_db()

    if not all([APP_KEY, APP_SECRET, BASE_URL]):
        logger.error("í•„ìˆ˜ API ì„¤ì •ì´ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤. config.ini íŒŒì¼ì„ í™•ì¸í•˜ê³  ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë‹¤ì‹œ ì‹¤í–‰í•´ì£¼ì„¸ìš”.")
        exit()

    token_params = {
        'grant_type': 'client_credentials',
        'appkey': APP_KEY,
        'secretkey': APP_SECRET,
    }

    token_response = kiwoom_api.issue_access_token(base_url=BASE_URL, data=token_params)

    access_token = token_response.get('access_token') if token_response else None

    if access_token:
        all_stocks = []

        kospi_stocks = get_all_stocks_list_by_market(access_token, BASE_URL, '0')
        all_stocks.extend(kospi_stocks)

        kosdaq_stocks = get_all_stocks_list_by_market(access_token, BASE_URL, '10')
        all_stocks.extend(kosdaq_stocks)

        if all_stocks:
            logger.info(f"\n--- ìµœì¢…ì ìœ¼ë¡œ ìˆ˜ì§‘ëœ ì „ì²´ ì¢…ëª© ìˆ˜: {len(all_stocks)}ê°œ ---")
            kiwoom_api.save_all_stocks_to_db(all_stocks)
        else:
            logger.info("ìˆ˜ì§‘ëœ ì¢…ëª© ì •ë³´ê°€ ì—†ì–´ DB ì €ì¥ì„ ê±´ë„ˆê¹ë‹ˆë‹¤.")
    else:
        logger.error("í† í° ë°œê¸‰ ì‹¤íŒ¨ë¡œ ì¸í•´ ì¢…ëª© ì •ë³´ë¥¼ ì—…ë°ì´íŠ¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìœ„ ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.")

    logger.info("--- ì „ì¢…ëª© ì •ë³´ ì—…ë°ì´íŠ¸ ì™„ë£Œ ---")
3. realtime_data_updater.py (ìƒˆë¡­ê²Œ ì¶”ê°€)
ì´ ìŠ¤í¬ë¦½íŠ¸ëŠ” python_modules í´ë”ì— ìƒˆë¡œ ìƒì„±í•´ì•¼ í•©ë‹ˆë‹¤. WebSocketì„ í†µí•´ ì‹¤ì‹œê°„ ë°ì´í„°ë¥¼ ìˆ˜ì‹ í•˜ê³  stock_data.dbì— ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.

Python

import asyncio
import websockets
import json
import configparser
import os
import sqlite3
import datetime
import logging
import time # For sleep in main loop
import kiwoom_api # kiwoom_api ëª¨ë“ˆ import

# --- íŒŒì¼ ê²½ë¡œ ë° ë¡œê±° ì„¤ì • (kiwoom_apiì™€ ì¼ê´€ë˜ê²Œ ì„¤ì •) ---
CURRENT_DIR = os.path.dirname(os.path.abspath(__file__))
PROJECT_ROOT = os.path.join(CURRENT_DIR, '..')

CONFIG_FILE = os.path.join(PROJECT_ROOT, 'config.ini')
DB_FILE = os.path.join(PROJECT_ROOT, 'stock_data.db')
LOG_DIR = os.path.join(PROJECT_ROOT, 'logs')
os.makedirs(LOG_DIR, exist_ok=True)

LOG_FILE = os.path.join(LOG_DIR, f"realtime_updater_{datetime.datetime.now().strftime('%Y%m%d')}.log")
logger = logging.getLogger(__name__) # Use __name__ to differentiate from kiwoom_api's logger
logger.setLevel(logging.INFO)
file_handler = logging.FileHandler(LOG_FILE, encoding='utf-8')
file_handler.setFormatter(logging.Formatter('%(asctime)s - %(name)s - %(levelname)s - %(message)s'))
logger.addHandler(file_handler)

# --- ì„¤ì • ë¡œë“œ ---
config = configparser.ConfigParser()
config.read(CONFIG_FILE)

try:
    BASE_URL = config.get('API', 'BASE_URL')
    APP_KEY = config.get('API', 'APP_KEY')
    APP_SECRET = config.get('API', 'APP_SECRET')
    SOCKET_URL = 'wss://mockapi.kiwoom.com:10000/api/dostk/websocket' # ëª¨ì˜íˆ¬ì WebSocket URL ê³ ì •
except (configparser.NoSectionError, configparser.NoOptionError) as e:
    logger.error(f"ì˜¤ë¥˜: config.ini íŒŒì¼ì˜ ë‚´ìš©ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. ({e})")
    logger.error("Please ensure [API] section and BASE_URL, APP_KEY, APP_SECRET keys are present.")
    BASE_URL = None
    APP_KEY = None
    APP_SECRET = None
    SOCKET_URL = None

# --- DB ì—…ë°ì´íŠ¸ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ---
def update_stock_realtime_data(stock_code, data):
    conn = None
    try:
        conn = sqlite3.connect(DB_FILE)
        cursor = conn.cursor()

        # ì‹¤ì œ API ì‘ë‹µì— ë”°ë¼ í‚¤ ì´ë¦„ì€ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        # ì•„ë˜ëŠ” ì˜ˆìƒë˜ëŠ” í‚¤ ì´ë¦„ì´ë©°, ì‹¤ì œ ì‘ë‹µì„ ë³´ê³  ë§ì¶°ì•¼ í•©ë‹ˆë‹¤.
        # ì‚¬ìš©ì ì œê³µ ì˜ˆì‹œ (0A íƒ€ì…)ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì¼ë°˜ì ì¸ í•„ë“œë¥¼ ì¶”ì •í•©ë‹ˆë‹¤.
        
        # 'current_price' ëŒ€ì‹  'lastPrice'ë¥¼ ì‚¬ìš©í•  ê°€ëŠ¥ì„± ìˆìŒ (get_all_stocks.pyì™€ ì¼ê´€)
        current_price = float(data.get('lastPrice', '0').replace(',', '')) if data.get('lastPrice') else 0.0
        # ì´í•˜ëŠ” Mock APIì˜ 0A íƒ€ì…ì´ ì–´ë–¤ í•„ë“œë¥¼ ì œê³µí•˜ëŠ”ì§€ì— ë”°ë¼ ë‹¬ë¼ì§‘ë‹ˆë‹¤.
        # ì„ì‹œë¡œ 'changeFromPrevDay', 'fluctuationRate', 'tradeVolume', 'tradeAmount'ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
        # ì‹¤ì œ API ì‘ë‹µì—ì„œ í•´ë‹¹ ê°’ë“¤ì˜ ì •í™•í•œ í‚¤ ì´ë¦„ì„ í™•ì¸í•˜ê³  í•„ìš” ì‹œ ìˆ˜ì •í•´ì•¼ í•©ë‹ˆë‹¤.
        change_from_prev_day = float(data.get('changeFromPrevDay', '0').replace(',', '')) if data.get('changeFromPrevDay') else 0.0
        fluctuation_rate = str(data.get('fluctuationRate', ''))
        trade_volume = int(data.get('tradeVolume', '0').replace(',', '')) if data.get('tradeVolume') else 0
        trade_amount = int(data.get('tradeAmount', '0').replace(',', '')) if data.get('tradeAmount') else 0

        cursor.execute('''
            UPDATE korean_stock_list
            SET cur_prc = ?, cmpr_yd = ?, flu_rt = ?, trde_qty = ?, trde_amt = ?, last_updated = CURRENT_TIMESTAMP
            WHERE stk_cd = ?
        ''', (current_price, change_from_prev_day, fluctuation_rate, trade_volume, trade_amount, stock_code))
        conn.commit()
        logger.debug(f"DB ì—…ë°ì´íŠ¸ ì™„ë£Œ: ì¢…ëª©ì½”ë“œ={stock_code}, í˜„ì¬ê°€={current_price}, ì „ì¼ëŒ€ë¹„={change_from_prev_day}, ë“±ë½ë¥ ={fluctuation_rate}, ê±°ë˜ëŸ‰={trade_volume}, ê±°ë˜ëŒ€ê¸ˆ={trade_amount}")
    except Exception as e:
        logger.error(f"ì¢…ëª© {stock_code}ì˜ ì‹¤ì‹œê°„ ë°ì´í„° DB ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
    finally:
        if conn:
            conn.close()

# --- WebSocket í´ë¼ì´ì–¸íŠ¸ í´ë˜ìŠ¤ ---
class WebSocketClient:
    def __init__(self, uri, access_token):
        self.uri = uri
        self.access_token = access_token
        self.websocket = None
        self.connected = False
        self.keep_running = True
        self.stock_codes_to_subscribe = []

    async def connect(self):
        try:
            self.websocket = await websockets.connect(self.uri)
            self.connected = True
            logger.info("ì„œë²„ì™€ ì—°ê²°ì„ ì‹œë„ ì¤‘ì…ë‹ˆë‹¤.")

            param = {
                'trnm': 'LOGIN',
                'token': self.access_token
            }

            logger.info('ì‹¤ì‹œê°„ ì‹œì„¸ ì„œë²„ë¡œ ë¡œê·¸ì¸ íŒ¨í‚·ì„ ì „ì†¡í•©ë‹ˆë‹¤.')
            await self.send_message(message=param)

        except Exception as e:
            logger.error(f'ì—°ê²° ì˜¤ë¥˜ ë°œìƒ: {e}')
            self.connected = False
            await asyncio.sleep(5)

    async def send_message(self, message):
        if not self.connected:
            await self.connect()
        if self.connected:
            if not isinstance(message, str):
                message = json.dumps(message)

            try:
                await self.websocket.send(message)
                logger.debug(f'ë©”ì‹œì§€ ì „ì†¡: {message}')
            except websockets.exceptions.ConnectionClosedOK:
                logger.warning("ë©”ì‹œì§€ ì „ì†¡ ì¤‘ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤. ì¬ì—°ê²° ì‹œë„...")
                self.connected = False
                await self.connect()
                if self.connected:
                    await self.websocket.send(message)
            except Exception as e:
                logger.error(f"ë©”ì‹œì§€ ì „ì†¡ ì˜¤ë¥˜: {e}")
                self.connected = False

    async def receive_messages(self):
        while self.keep_running:
            try:
                response_str = await self.websocket.recv()
                response = json.loads(response_str)

                if response.get('trnm') == 'LOGIN':
                    if response.get('return_code') != 0:
                        logger.error(f'ë¡œê·¸ì¸ ì‹¤íŒ¨: {response.get("return_msg")}')
                        await self.disconnect()
                    else:
                        logger.info('ë¡œê·¸ì¸ ì„±ê³µ.')
                        await self.subscribe_to_stocks()

                elif response.get('trnm') != 'PING':
                    logger.info(f'ì‹¤ì‹œê°„ ì‹œì„¸ ì„œë²„ ì‘ë‹µ ìˆ˜ì‹ : {response}')
                    if response.get('trnm') == 'REAL' and response.get('item'):
                        stock_code = response['item']
                        # '0A' íƒ€ì…ì˜ ì‘ë‹µ êµ¬ì¡°ì— ë”°ë¼ ë°ì´í„° ì¶”ì¶œ
                        # Mock APIì˜ ì‹¤ì œ ì‘ë‹µ êµ¬ì¡°ë¥¼ í™•ì¸í•˜ì—¬ í•„ë“œ ì´ë¦„ì„ ì¡°ì •í•˜ì„¸ìš”.
                        realtime_data = response.get('0A', response)
                        update_stock_realtime_data(stock_code, realtime_data)

            except websockets.ConnectionClosed:
                logger.warning('ì„œë²„ì— ì˜í•´ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤. ì¬ì—°ê²° ì‹œë„...')
                self.connected = False
                await self.websocket.close()
                await asyncio.sleep(5)
                if self.keep_running:
                    await self.connect()
            except json.JSONDecodeError:
                logger.error(f"JSON íŒŒì‹± ì˜¤ë¥˜. ìˆ˜ì‹ ëœ ì‘ë‹µ: {response_str[:200]}...")
            except asyncio.CancelledError:
                logger.info("ë©”ì‹œì§€ ìˆ˜ì‹  íƒœìŠ¤í¬ê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.")
                break
            except Exception as e:
                logger.error(f'ë©”ì‹œì§€ ìˆ˜ì‹  ì˜¤ë¥˜: {e}')
                await asyncio.sleep(1)

    async def run(self):
        while self.keep_running:
            if not self.connected:
                await self.connect()
                if not self.connected:
                    await asyncio.sleep(10)
                    continue
            await self.receive_messages()

    async def subscribe_to_stocks(self):
        if not self.stock_codes_to_subscribe:
            logger.info("êµ¬ë…í•  ì¢…ëª© ì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤. ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì¢…ëª© ì½”ë“œë¥¼ ë¡œë“œí•´ì£¼ì„¸ìš”.")
            return

        # ëª¨ë“  ì¢…ëª© ì½”ë“œë¥¼ í•œ ë²ˆì— 'item' ë¦¬ìŠ¤íŠ¸ì— ë‹´ì•„ êµ¬ë… ìš”ì²­
        # ì‹¤ì œ APIëŠ” ë™ì‹œì— êµ¬ë…í•  ìˆ˜ ìˆëŠ” í•­ëª© ìˆ˜ì— ì œí•œì´ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        # (ì˜ˆ: 100ê°œ í•­ëª© ì œí•œ). ì œí•œì— ê±¸ë¦¬ë©´ ì—¬ëŸ¬ ë²ˆì— ë‚˜ëˆ„ì–´ ìš”ì²­í•´ì•¼ í•©ë‹ˆë‹¤.
        subscription_data_entry = {
            'item': self.stock_codes_to_subscribe, # ëª¨ë“  ì¢…ëª© ì½”ë“œë¥¼ ë¦¬ìŠ¤íŠ¸ë¡œ ì „ë‹¬
            'type': ['0A'], # ê¸°ë³¸ ì‹¤ì‹œê°„ ì‹œì„¸ (ì²´ê²°) ë°ì´í„° íƒ€ì…
        }

        reg_message = {
            'trnm': 'REG',
            'grp_no': '1',
            'refresh': '1',
            'data': [subscription_data_entry]
        }

        logger.info(f"ì‹¤ì‹œê°„ í•­ëª© ë“±ë¡ ìš”ì²­ ì „ì†¡ (ì´ {len(self.stock_codes_to_subscribe)}ê°œ ì¢…ëª©).")
        await self.send_message(reg_message)
        logger.info("ì‹¤ì‹œê°„ í•­ëª© ë“±ë¡ ìš”ì²­ ì „ì†¡ ì™„ë£Œ.")


    async def disconnect(self):
        self.keep_running = False
        if self.connected and self.websocket:
            await self.websocket.close()
            self.connected = False
            logger.info('WebSocket ì„œë²„ ì—°ê²° í•´ì œë¨')

# --- ë©”ì¸ ì‹¤í–‰ ë¡œì§ ---
async def main():
    logger.info("--- ì‹¤ì‹œê°„ ì¢…ëª© ì‹œì„¸ ì—…ë°ì´íŠ¸ ìŠ¤í¬ë¦½íŠ¸ ì‹œì‘ ---")

    if not all([APP_KEY, APP_SECRET, BASE_URL, SOCKET_URL]):
        logger.error("config.iniì—ì„œ API ì„¤ì • ë˜ëŠ” WebSocket URLì„ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
        return

    # ì ‘ê·¼ í† í° ë°œê¸‰ (kiwoom_api ëª¨ë“ˆ ì¬ì‚¬ìš©)
    token_data = {'grant_type': 'client_credentials', 'appkey': APP_KEY, 'secretkey': APP_SECRET}
    token_response = kiwoom_api.issue_access_token(base_url=BASE_URL, data=token_data)
    access_token = token_response.get('access_token') if token_response else None

    if not access_token:
        logger.error("ì ‘ê·¼ í† í°ì„ ë°œê¸‰ë°›ì„ ìˆ˜ ì—†ì–´ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
        return

    # DBì—ì„œ ëª¨ë“  ì¢…ëª© ì½”ë“œ ë¡œë“œ
    all_stock_codes = []
    conn = None
    try:
        conn = sqlite3.connect(DB_FILE)
        cursor = conn.cursor()
        cursor.execute("SELECT stk_cd FROM korean_stock_list")
        all_stock_codes = [row[0] for row in cursor.fetchall()]
        logger.info(f"ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì´ {len(all_stock_codes)}ê°œì˜ ì¢…ëª© ì½”ë“œë¥¼ ë¡œë“œí–ˆìŠµë‹ˆë‹¤.")
        if not all_stock_codes:
            logger.warning("ë°ì´í„°ë² ì´ìŠ¤ì— ì¢…ëª© ì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤. get_all_stocks.pyë¥¼ ë¨¼ì € ì‹¤í–‰í•˜ì—¬ ì¢…ëª©ì„ ë¡œë“œí•´ì£¼ì„¸ìš”.")
            return
    except Exception as e:
        logger.error(f"ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì¢…ëª© ì½”ë“œë¥¼ ë¡œë“œí•˜ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
        return
    finally:
        if conn:
            conn.close()

    websocket_client = WebSocketClient(SOCKET_URL, access_token)
    websocket_client.stock_codes_to_subscribe = all_stock_codes

    receive_task = asyncio.create_task(websocket_client.run())

    # ìŠ¤í¬ë¦½íŠ¸ê°€ ê³„ì† ì‹¤í–‰ë˜ë„ë¡ ìœ ì§€ (ë¹„ë™ê¸° íƒœìŠ¤í¬ë¥¼ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹¤í–‰)
    try:
        while True:
            await asyncio.sleep(3600) # 1ì‹œê°„ë§ˆë‹¤ ê¹¨ì–´ë‚˜ ì—°ê²° ìƒíƒœ í™•ì¸ ë“± (ì‹¤ì œ ë¡œì§ì€ receive_messagesì—ì„œ ì²˜ë¦¬)
    except asyncio.CancelledError:
        logger.info("ë©”ì¸ ë£¨í”„ê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.")
    finally:
        await websocket_client.disconnect()
        logger.info("--- ì‹¤ì‹œê°„ ì¢…ëª© ì‹œì„¸ ì—…ë°ì´íŠ¸ ìŠ¤í¬ë¦½íŠ¸ ì¢…ë£Œ ---")


if __name__ == '__main__':
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        logger.info("ìŠ¤í¬ë¦½íŠ¸ê°€ ì‚¬ìš©ì ìš”ì²­ì— ì˜í•´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.")
    except Exception as e:
        logger.error(f"ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì¤‘ ì˜ˆê¸°ì¹˜ ì•Šì€ ì˜¤ë¥˜ ë°œìƒ: {e}")
4. fetch_all_stocks.php (ë³€ê²½ ì—†ìŒ - ì¬í™•ì¸ìš©)
ì´ì „ì— ìˆ˜ì •í•´ ë“œë¦° fetch_all_stocks.php íŒŒì¼ê³¼ ë™ì¼í•©ë‹ˆë‹¤. ì´ íŒŒì¼ì€ stock_data.dbì—ì„œ ë°ì´í„°ë¥¼ ì½ê¸°ë§Œ í•©ë‹ˆë‹¤.

PHP

<?php
// Set a longer timeout for this script as fetching all stocks from DB might take time for large datasets.
set_time_limit(120); // 2 minutes, adjusted from 5 minutes as Python execution is removed.

// ì´ PHP ìŠ¤í¬ë¦½íŠ¸ëŠ” ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì¢…ëª© ì •ë³´ë¥¼ ì½ì–´ì™€ HTMLë¡œ ì¶œë ¥í•©ë‹ˆë‹¤.
// íŒŒì´ì¬ ìŠ¤í¬ë¦½íŠ¸(get_all_stocks.py)ëŠ” ë³„ë„ì˜ ìŠ¤ì¼€ì¤„ëŸ¬(ì˜ˆ: cron job)ë¥¼ í†µí•´
// ì£¼ê¸°ì ìœ¼ë¡œ ì‹¤í–‰ë˜ì–´ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì—…ë°ì´íŠ¸í•´ì•¼ í•©ë‹ˆë‹¤.
// ì›¹ ìš”ì²­ ì‹œë§ˆë‹¤ íŒŒì´ì¬ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•˜ëŠ” ê²ƒì€ ë¹„íš¨ìœ¨ì ì´ë©°, API ìš”ì²­ ì œí•œì— ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

$search_term = $_GET['search'] ?? '';
$db_file = '/home/stock/public_html/stock_data.db'; // stock_data.db íŒŒì¼ì˜ ì‹¤ì œ ê²½ë¡œ

$data = [];
$error_message = '';

try {
    $pdo = new PDO('sqlite:' . $db_file);
    $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
    $pdo->setAttribute(PDO::ATTR_DEFAULT_FETCH_MODE, PDO::FETCH_ASSOC); // ê²°ê³¼ë¥¼ ì—°ê´€ ë°°ì—´ë¡œ ê°€ì ¸ì˜¤ê¸°

    $sql = "SELECT stk_cd, stk_nm, cur_prc, cmpr_yd, flu_rt, trde_qty, trde_amt FROM korean_stock_list";
    $params = [];

    if (!empty($search_term)) {
        $sql .= " WHERE stk_nm LIKE ? OR stk_cd LIKE ?";
        $params[] = '%' . $search_term . '%';
        $params[] = '%' . $search_term . '%';
    }

    $sql .= " ORDER BY trde_amt DESC"; // ê±°ë˜ëŒ€ê¸ˆ ê¸°ì¤€ìœ¼ë¡œ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬

    $stmt = $pdo->prepare($sql);
    $stmt->execute($params);
    $data = $stmt->fetchAll();

} catch (PDOException $e) {
    $error_message = "ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ë˜ëŠ” ì¿¼ë¦¬ ì˜¤ë¥˜: " . htmlspecialchars($e->getMessage());
    error_log("Database error in fetch_all_stocks.php: " . $e->getMessage());
} catch (Exception $e) {
    $error_message = "ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " . htmlspecialchars($e->getMessage());
    error_log("Unexpected error in fetch_all_stocks.php: " . $e->getMessage());
}

// ë°ì´í„° í‘œì‹œ
if (!empty($error_message)) {
    echo "<p class=\"error\">" . $error_message . "</p>";
} elseif (!empty($data)) {
    if (!empty($search_term)) {
        echo "<p>'" . htmlspecialchars($search_term) . "' ê²€ìƒ‰ ê²°ê³¼: ì´ " . count($data) . "ê°œì˜ ì¢…ëª©ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤.</p>";
    } else {
        echo "<p>ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì´ " . count($data) . "ê°œì˜ ì¢…ëª©ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤. (ê±°ë˜ëŒ€ê¸ˆ ìˆœ ì •ë ¬)</p>";
    }

    echo "<table>";
    echo "<thead><tr><th>ì¢…ëª©ì½”ë“œ</th><th>ì¢…ëª©ëª…</th><th>í˜„ì¬ê°€</th><th>ì „ì¼ëŒ€ë¹„</th><th>ë“±ë½ë¥ </th><th>ê±°ë˜ëŸ‰</th><th>ê±°ë˜ëŒ€ê¸ˆ</th></tr></thead>";
    echo "<tbody>";
    foreach ($data as $stock) {
        echo "<tr>";
        echo "<td>" . htmlspecialchars($stock['stk_cd'] ?? '') . "</td>";
        echo "<td>" . htmlspecialchars($stock['stk_nm'] ?? '') . "</td>";
        echo "<td>" . htmlspecialchars(number_format($stock['cur_prc'] ?? 0)) . "</td>";
        echo "<td>" . htmlspecialchars(number_format($stock['cmpr_yd'] ?? 0)) . "</td>";
        echo "<td>" . htmlspecialchars($stock['flu_rt'] ?? '') . "</td>";
        echo "<td>" . htmlspecialchars(number_format($stock['trde_qty'] ?? 0)) . "</td>";
        echo "<td>" . htmlspecialchars(number_format($stock['trde_amt'] ?? 0)) . "</td>";
        echo "</tr>";
    }
    echo "</tbody></table>";
} else {
    if (!empty($search_term)) {
        echo "<p>'" . htmlspecialchars($search_term) . "'ì— ëŒ€í•œ ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
    } else {
        echo "<p class=\"info\">ë°ì´í„°ë² ì´ìŠ¤ì— ì¡°íšŒëœ ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤. íŒŒì´ì¬ ìŠ¤í¬ë¦½íŠ¸(get_all_stocks.py)ë¥¼ ë¨¼ì € ì‹¤í–‰í•˜ì—¬ ì¢…ëª©ì„ ë¡œë“œí•´ì£¼ì„¸ìš”.</p>";
    }
}
?>
êµ¬í˜„ ë° ì‹¤í–‰ ê°€ì´ë“œ
kiwoom_api.py ì—…ë°ì´íŠ¸: ì´ì „ì— ì œê³µëœ íŒŒì¼ê³¼ ë™ì¼í•œ ë‚´ìš©ì¸ì§€ í™•ì¸í•˜ê³ , í•„ìš”í•œ ê²½ìš° python_modules í´ë”ì— ë®ì–´ì“°ê¸° í•©ë‹ˆë‹¤.

get_all_stocks.py ì—…ë°ì´íŠ¸: ì´ì „ì— ì œê³µëœ íŒŒì¼ê³¼ ë™ì¼í•œ ë‚´ìš©ì¸ì§€ í™•ì¸í•˜ê³ , í•„ìš”í•œ ê²½ìš° python_modules í´ë”ì— ë®ì–´ì“°ê¸° í•©ë‹ˆë‹¤.

ìƒˆ íŒŒì¼ ìƒì„± realtime_data_updater.py: python_modules í´ë” ë‚´ì— realtime_data_updater.py íŒŒì¼ì„ ìƒˆë¡œ ìƒì„±í•˜ê³ , ìœ„ì— ì œê³µëœ ì½”ë“œë¥¼ ë¶™ì—¬ë„£ìŠµë‹ˆë‹¤.

config.ini í™•ì¸: APP_KEY, APP_SECRET, BASE_URLì´ ì˜¬ë°”ë¥´ê²Œ ì„¤ì •ë˜ì–´ ìˆëŠ”ì§€ ë‹¤ì‹œ í•œë²ˆ í™•ì¸í•©ë‹ˆë‹¤.

ì‹¤í–‰ ìˆœì„œ (ì¤‘ìš”!):

1ë‹¨ê³„: ì¢…ëª© ë¦¬ìŠ¤íŠ¸ ì´ˆê¸°í™” (ìµœì´ˆ 1íšŒ ë° ì£¼ê¸°ì  ì‹¤í–‰)
get_all_stocks.pyë¥¼ ë¨¼ì € ì‹¤í–‰í•˜ì—¬ stock_data.dbì— ì¢…ëª© ì½”ë“œì™€ ê¸°ë³¸ ì •ë³´ë¥¼ ì±„ì›Œ ë„£ì–´ì•¼ í•©ë‹ˆë‹¤.

Bash

cd /home/stock/public_html/python_modules/
python3 get_all_stocks.py
ì´ ìŠ¤í¬ë¦½íŠ¸ëŠ” ì½˜ì†”ì— ì•„ë¬´ê²ƒë„ ì¶œë ¥í•˜ì§€ ì•Šìœ¼ë©°, ë¡œê·¸ëŠ” logs/kiwoom_api_YYYYMMDD.logì— ê¸°ë¡ë©ë‹ˆë‹¤.

2ë‹¨ê³„: ì‹¤ì‹œê°„ ë°ì´í„° ì—…ë°ì´íŠ¸ (ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì§€ì† ì‹¤í–‰)
ì´ì œ realtime_data_updater.pyë¥¼ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹¤í–‰í•˜ì—¬ stock_data.dbì˜ 'ì „ì¼ëŒ€ë¹„', 'ë“±ë½ë¥ ', 'ê±°ë˜ëŸ‰', 'ê±°ë˜ëŒ€ê¸ˆ' í•„ë“œë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ì—…ë°ì´íŠ¸í•˜ê²Œ í•©ë‹ˆë‹¤.

Bash

cd /home/stock/public_html/python_modules/
nohup python3 realtime_data_updater.py > /dev/null 2>&1 &
nohup ... & ëª…ë ¹ì€ í„°ë¯¸ë„ì„ ë‹«ì•„ë„ ìŠ¤í¬ë¦½íŠ¸ê°€ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ê³„ì† ì‹¤í–‰ë˜ë„ë¡ í•©ë‹ˆë‹¤. ë¡œê·¸ëŠ” logs/realtime_updater_YYYYMMDD.logì— ê¸°ë¡ë©ë‹ˆë‹¤.

fetch_all_stocks.php ì—…ë°ì´íŠ¸: ì´ì „ì— ì œê³µëœ íŒŒì¼ê³¼ ë™ì¼í•œ ë‚´ìš©ì¸ì§€ í™•ì¸í•˜ê³ , í•„ìš”í•œ ê²½ìš° public_html í´ë”ì— ë®ì–´ì“°ê¸° í•©ë‹ˆë‹¤.

ì›¹í˜ì´ì§€ í™•ì¸: http://stock.mizrino.com/all_stocks.php í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ 'ì „ì¼ëŒ€ë¹„', 'ë“±ë½ë¥ ', 'ê±°ë˜ëŸ‰', 'ê±°ë˜ëŒ€ê¸ˆ' ì»¬ëŸ¼ì— ì‹¤ì‹œê°„ ë°ì´í„°ê°€ ì±„ì›Œì§€ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.

ì°¸ê³ :

realtime_data_updater.pyì˜ update_stock_realtime_data í•¨ìˆ˜ ë‚´ë¶€ì—ì„œ data.get('lastPrice', '0'), data.get('changeFromPrevDay', '0') ë“±ìœ¼ë¡œ í•„ë“œë¥¼ ê°€ì ¸ì˜¤ëŠ” ë¶€ë¶„ì€ ì‹¤ì œ í‚¤ì›€ì¦ê¶Œ ëª¨ì˜íˆ¬ì WebSocket API ì‘ë‹µì˜ JSON êµ¬ì¡°ì— ë”°ë¼ ì¡°ì •ì´ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. logs/realtime_updater_YYYYMMDD.log íŒŒì¼ì— ê¸°ë¡ë˜ëŠ” ì‹¤ì‹œê°„ ì‹œì„¸ ì„œë²„ ì‘ë‹µ ìˆ˜ì‹  ë¡œê·¸ë¥¼ í™•ì¸í•˜ì—¬ ì‹¤ì œ ì‘ë‹µ í•„ë“œ ì´ë¦„ì„ í™•ì¸ í›„ realtime_data_updater.py íŒŒì¼ì„ ìˆ˜ì •í•´ì•¼ í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.

ëª¨ì˜íˆ¬ì APIì˜ WebSocket êµ¬ë… ì œí•œì— ë”°ë¼, ìˆ˜ì²œ ê°œì˜ ì¢…ëª©ì„ í•œ ë²ˆì— êµ¬ë…í•˜ëŠ” ê²ƒì´ ë¶ˆê°€ëŠ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ê²½ìš° subscribe_to_stocks í•¨ìˆ˜ ë‚´ì—ì„œ ì¢…ëª© ë¦¬ìŠ¤íŠ¸ë¥¼ ì—¬ëŸ¬ ë¬¶ìŒìœ¼ë¡œ ë‚˜ëˆ„ì–´ ìˆœì°¨ì ìœ¼ë¡œ REG ìš”ì²­ì„ ë³´ë‚´ëŠ” ë¡œì§(batching)ì„ êµ¬í˜„í•´ì•¼ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.