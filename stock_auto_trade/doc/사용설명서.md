# 주식 자동매매 시스템 사용 설명서 (v1.2)

## 1. 개요
본 문서는 키움증권 REST API를 활용한 주식 자동매매 시스템의 설치, 설정 및 사용 방법을 상세히 안내합니다. 이 시스템은 Python으로 구현된 자동매매 백엔드와 PHP로 제작된 웹 인터페이스를 연동하여, 실시간으로 주식 정보를 모니터링하고 매매를 제어하는 기능을 제공합니다.

## 2. 시스템 요구사항
*   **서버 환경**: Linux (PHP, Apache/Nginx 웹 서버 실행 환경)
*   **백엔드**: Python 3.8 이상
*   **프론트엔드**: PHP 7.4 이상, 웹 브라우저 (Chrome, Firefox 등)

## 3. 설치 및 설정

### 3.1. 소스 코드 다운로드
Git을 사용하여 프로젝트를 복제하거나 소스 코드를 다운로드합니다.
```bash
git clone [저장소 URL] /home/stock/public_html/stock_auto_trade
cd /home/stock/public_html/stock_auto_trade
```

### 3.2. Python 환경 설정
1.  **가상 환경 생성 및 활성화 (권장)**:
    ```bash
    python3 -m venv venv
    source venv/bin/activate
    ```
2.  **필수 라이브러리 설치**:
    `stock_auto_trade` 디렉토리 내의 `requirements.txt` 파일을 사용하여 필요한 Python 라이브러리를 설치합니다.
    ```bash
    pip install -r requirements.txt
    ```

### 3.3. API 키 및 환경 설정 (`config.ini`)
`stock_auto_trade/config.ini` 파일은 시스템의 핵심 설정을 담고 있습니다. 각 항목을 사용자의 환경에 맞게 수정해야 합니다.

```ini
[API]
# 키움증권 API 키 (모의투자 또는 실투자)
APP_KEY = YOUR_KIWOOM_APP_KEY
APP_SECRET = YOUR_KIWOOM_APP_SECRET

# 키움증권(한국투자증권) REST API 공식 서버 주소
# 실전투자: https://openapi.koreainvestment.com:9443
# 모의투자: https://openapivts.koreainvestment.com:29443
# (참고: mockapi.kiwoom.com, api.kiwoom.com은 구버전 또는 다른 API의 주소입니다.)
BASE_URL = https://openapivts.koreainvestment.com:29443

[TRADING]
# 매매 관련 설정
TOTAL_BUDGET = 1000000         # 총 매수 가능 금액 (원)
MAX_BUY_PER_STOCK = 100000   # 종목당 최대 매수 금액 (원)
STOP_LOSS_RATE = -2.0          # 손절매 기준 수익률 (%)
PROFIT_TAKING_RATE = -2.0      # 익절매 기준 수익률 (상승 후 하락 전환 시)
MIN_PROFIT_RATE = 3.0          # 최소 익절 수익률 (%)

[NAVER_API]
# 네이버 뉴스 검색 API 키
CLIENT_ID = YOUR_NAVER_CLIENT_ID
CLIENT_SECRET = YOUR_NAVER_CLIENT_SECRET

[KIWOOM]
# 키움증권 계좌번호 (하이픈(-) 포함 또는 미포함)
ACCOUNT_NUMBER = YOUR_ACCOUNT_NUMBER
```

### 3.4. 웹 서버 설정
PHP를 지원하는 웹 서버(예: Apache, Nginx)가 필요합니다. `/home/stock/public_html` 디렉토리를 웹 서버의 DocumentRoot로 설정해야 합니다.

**Apache 예시 (`/etc/apache2/sites-available/000-default.conf`):**
```apache
<VirtualHost *:80>
    ServerAdmin webmaster@localhost
    DocumentRoot /home/stock/public_html
    ErrorLog ${APACHE_LOG_DIR}/error.log
    CustomLog ${APACHE_LOG_DIR}/access.log combined
</VirtualHost>
```
설정 변경 후 웹 서버를 재시작해야 합니다.
```bash
sudo systemctl restart apache2
```

## 4. 시스템 실행 및 자동화

운영 환경에서는 안정적인 서비스 운영을 위해 **Gunicorn**과 **Systemd**를 사용하고, 데이터 수집은 **Cron**으로 자동화하는 것을 강력히 권장합니다.

### 4.1. 백엔드 서비스 실행 (Gunicorn & Systemd)
1.  **Systemd 서비스 파일 복사**:
    프로젝트에 포함된 `/home/stock/public_html/stock_auto_trade/doc/stock-autotrade.service` 파일을 시스템의 서비스 디렉토리로 복사합니다.
    ```bash
    sudo cp /home/stock/public_html/stock_auto_trade/doc/stock-autotrade.service /etc/systemd/system/stock-autotrade.service
    ```

2.  **백엔드 서비스 시작 및 활성화**:
    Systemd를 사용하여 백엔드 서버를 서비스로 등록하고 실행합니다.
    ```bash
    sudo systemctl daemon-reload
    sudo systemctl start stock-autotrade.service
    sudo systemctl enable stock-autotrade.service
    ```

3.  **서비스 상태 확인**:
    아래 명령어로 서비스가 정상적으로 실행 중인지 확인할 수 있습니다.
    ```bash
    sudo systemctl status stock-autotrade.service
    ```
    출력된 내용 중 `Active: active (running)` 상태가 표시되면 정상입니다.

### 4.2. 데이터 파이프라인 자동화 (Cron)
자동매매 로직이 최신 데이터를 기반으로 동작하려면, 데이터 수집 스크립트들을 주기적으로 실행해야 합니다. `run_data_pipeline.py` 스크립트가 이 과정을 자동화하며, Cron을 사용해 스케줄링할 수 있습니다.

1.  **Crontab 편집기 열기**:
    ```bash
    crontab -e
    ```

2.  **스케줄 추가**:
    아래 라인을 crontab 파일의 맨 아래에 추가합니다. 이 설정은 **매일 아침 9시**에 데이터 파이프라인을 실행합니다.
    ```crontab
    # 매일 오전 9시에 주식 데이터 파이프라인 실행
    0 9 * * * /home/stock/public_html/stock_auto_trade/venv/bin/python /home/stock/public_html/stock_auto_trade/run_data_pipeline.py >> /home/stock/public_html/stock_auto_trade/logs/cron.log 2>&1
    ```
    *   **경로 확인**: 위 경로는 실제 환경에 맞게 수정해야 할 수 있습니다.
    *   **로그**: 실행 결과 및 오류는 `logs/cron.log` 파일에 기록됩니다. 문제가 발생하면 이 파일을 확인하세요. (`logs` 디렉토리가 없다면 `mkdir logs`로 생성해주세요.)

3.  **저장 및 종료**:
    편집기를 저장하고 닫습니다. 이제 스케줄이 자동으로 적용됩니다.

### 4.3. 웹 인터페이스 접속
웹 브라우저를 열고 설정된 서버 주소(예: `http://localhost` 또는 서버의 IP 주소)로 접속하여 대시보드를 확인합니다.

## 5. 웹 인터페이스 사용법

### 5.1. 자동매매 제어
대시보드 상단의 제어 버튼을 통해 자동매매 시스템의 상태를 변경할 수 있습니다.
*   **자동매매 시작**: 백엔드 시스템의 자동매매 로직을 활성화합니다.
*   **자동매매 일시정지**: 현재 진행 중인 자동매매 로직을 일시적으로 멈춥니다.
*   **자동매매 중지**: 자동매매 로직을 완전히 중지합니다.

### 5.2. 손실률 설정
'손실 설정' 입력 필드에 원하는 손절매 비율(%)을 입력하고 '저장' 버튼을 누르면, `config.ini`의 `STOP_LOSS_RATE` 값이 업데이트되고 백엔드 로직에 즉시 반영됩니다.

### 5.3. 정보 모니터링
대시보드는 여러 섹션으로 나뉘어 다양한 정보를 실시간으로 제공합니다. (기본 30초 주기 갱신)
*   **미국 주식 TOP 30**: `yfinance`를 통해 조회한 미국 시장의 상승률 상위 30개 종목 정보를 표시합니다.
*   **국내 주식 (5일선 유지)**: 미국 주식 테마와 연관성이 있고, 5일 이동평균선을 유지하는 국내 주식 종목을 추천합니다.
*   **급등주**: 장 초반(09:00~09:20)에 전일 대비 거래량이 급등하는 종목을 포착하여 표시합니다.
*   **매매 현황**: 시스템을 통해 실행된 매수/매도 내역과 수익률을 실시간으로 보여줍니다.
*   **일봉/분봉 차트**: 특정 종목을 클릭했을 때 해당 종목의 차트 데이터를 시각화하여 보여줍니다.

## 6. 문제 해결 (FAQ)

### Q1: 웹 화면에 데이터가 표시되지 않습니다.
*   **A1**: 백엔드 서비스가 정상적으로 실행 중인지 `sudo systemctl status stock-autotrade.service` 명령어로 확인하세요. 문제가 있다면, `stock_auto_trade/app.log` 파일에 기록된 오류 로그를 확인하여 문제를 진단할 수 있습니다.

### Q2: 조건검색식 종목이 보이지 않습니다.
*   **A2**: 현재 키움증권 모의투자 API는 조건검색 '실행' 기능을 완벽하게 지원하지 않을 수 있습니다. `kiwoom_api.py`의 `execute_conditional_search` 함수가 빈 목록을 반환하는 것은 API의 제약일 가능성이 높습니다. 이 기능은 실거래 API에서 정상 작동할 수 있습니다.

### Q3: API 키 설정 후에도 인증 오류가 발생합니다.
*   **A3**: `config.ini` 파일에 기입한 `APP_KEY`와 `APP_SECRET`이 정확한지, 그리고 모의투자와 실투자용 키를 맞게 사용했는지 다시 한번 확인하세요. 또한, 키움증권 API는 등록된 IP 주소에서만 호출이 가능할 수 있으니, 서버의 IP가 키움증권에 등록되었는지 확인해야 합니다.

## 7. 개발 로드맵
본 프로젝트의 상세한 개발 계획 및 진행 상황은 `GEMINI.md` 파일에 기록되어 있습니다.